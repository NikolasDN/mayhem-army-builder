<div class="army-builder-container">
  <div class="header">
    <h2>Army Builder</h2>
    <div class="army-info">
      <input type="text" [(ngModel)]="armyName" placeholder="Army Name" class="army-name-input">
             <div class="stats">
         <span class="stat">Total Points: <strong>{{ totalPoints }}</strong></span>
         <span class="stat">Total Models: <strong>{{ totalModels }}</strong></span>
         <span class="stat">Total Rules: <strong>{{ totalRules }}</strong></span>
       </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    Loading BattleScribe data...
  </div>

  <div *ngIf="error" class="error">
    Error: {{ error }}
  </div>

  <div *ngIf="catalogue && !loading" class="main-content">
    <div class="left-panel">
      <h3>Add Models</h3>

      <div class="entries-list">
        <div 
          *ngFor="let entry of filteredEntries" 
          class="entry-item"
          [class.selected]="selectedEntry?.id === entry.id"
          [class.unavailable]="!isEntryAvailable(entry)"
          (click)="onEntrySelect(entry)"
        >
          <div class="entry-info">
            <h4>{{ entry.name }}</h4>
            <p><strong>Type:</strong> {{ entry.type }}</p>
            <p><strong>Points:</strong> {{ entry.points }}</p>
            <div *ngIf="!isEntryAvailable(entry)" class="condition-info">
              <p class="condition-text">{{ getConditionDescription(entry) }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="add-button-container">
        <button 
          (click)="addModelToArmy()" 
          [disabled]="!selectedEntry"
          class="add-button"
        >
          Add to Army
        </button>
      </div>
    </div>

          <div class="right-panel">
        <div class="army-controls">
          <button (click)="saveArmy()" class="save-button">Save Army</button>
          <button (click)="clearArmy()" class="clear-button">Clear Army</button>
          <button (click)="printArmy()" class="print-button" *ngIf="armyModels.length > 0">Print Army</button>
        </div>

        <h3>Your Army</h3>
        
        <div *ngIf="armyModels.length === 0" class="empty-army">
          <p>No models in your army yet. Select a model from the left panel and click "Add to Army".</p>
        </div>

        <div *ngIf="armyModels.length > 0" class="army-models">
                     <app-model
             *ngFor="let model of armyModels"
             [entry]="model.entry"
             [quantity]="model.quantity"
             [upgrades]="model.upgrades"
             [armyModels]="armyModels"
             [customName]="model.customName"
             (quantityChange)="updateModelQuantity(model.id, $event)"
             (nameChange)="updateModelName(model.id, $event)"
             (remove)="removeModelFromArmy(model.id)"
             (addUpgrade)="addUpgradeToModel(model.id, $event)"
             (removeUpgrade)="removeUpgradeFromModel(model.id, $event)"
           ></app-model>
        </div>

        <div class="saved-armies-section">
          <h3>Saved Armies</h3>
          
          <div *ngIf="savedArmies.length === 0" class="empty-saved-armies">
            <p>No saved armies yet. Build an army and click "Save Army" to save it.</p>
          </div>

          <div *ngIf="savedArmies.length > 0" class="saved-armies-list">
            <div *ngFor="let army of savedArmies" class="saved-army-item">
              <div class="saved-army-info">
                <h4>{{ army.name }}</h4>
                <div class="saved-army-stats">
                  <span>{{ army.totalPoints }} pts</span>
                  <span>{{ army.totalModels }} models</span>
                  <span>{{ army.totalRules }} rules</span>
                </div>
                <div class="saved-army-date">
                  {{ army.dateCreated | date:'short' }}
                </div>
              </div>
              <div class="saved-army-actions">
                <button (click)="loadArmy(army.id)" class="load-button">Load</button>
                <button (click)="deleteArmy(army.id)" class="delete-button">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
             <!-- Print Table (hidden by default, shown only when printing) -->
       <div class="print-table" style="display: none;">
         <table class="army-table">
           <thead>
             <tr>
               <th>Amount</th>
               <th>Name</th>
               <th>MOV</th>
               <th>CQ</th>
               <th>BAR</th>
               <th>Range</th>
               <th>Damage</th>
               <th>Specials</th>
               <th>Points</th>
             </tr>
           </thead>
           <tbody>
                                         <ng-container *ngFor="let model of armyModels">
                <!-- Main model row -->
                <tr class="army-row">
                  <td class="amount">{{ model.quantity }}</td>
                  <td class="name">{{ getModelDisplayName(model) }}</td>
                  <td class="mov">{{ getProfileValue(model.entry, 'MOV') }}</td>
                  <td class="cq">{{ getProfileValue(model.entry, 'CQ') }}</td>
                  <td class="bar">{{ getProfileValue(model.entry, 'BAR') }}</td>
                  <td class="range">{{ getUpgradeProfileValue(model.upgrades, 'Range') }}</td>
                  <td class="damage">{{ getUpgradeProfileValue(model.upgrades, 'Damage') }}</td>
                  <td class="specials">{{ getSpecials(model) }}</td>
                  <td class="points">{{ getModelTotalPoints(model) }}</td>
                </tr>
                
                <!-- Model rules row (if any) -->
                <tr *ngIf="hasModelRules(model)" class="model-rules-row">
                  <td colspan="9" class="model-rules-cell">
                    <div class="model-rules-print">
                      <strong>{{ getModelDisplayName(model) }} Rules:</strong>
                      <div *ngFor="let rule of model.entry.rules" class="model-rule-detail">
                        {{ rule.name }}: {{ rule.description }}
                      </div>
                    </div>
                  </td>
                </tr>
                
                <!-- Upgrade rules row (if any) -->
                <tr *ngIf="hasUpgradeRules(model)" class="upgrade-rules-row">
                  <td colspan="9" class="upgrade-rules-cell">
                    <div class="upgrade-rules-print">
                      <strong>{{ getModelDisplayName(model) }} Upgrades:</strong>
                      <div *ngFor="let upgrade of model.upgrades" class="upgrade-rule-print">
                        <strong>{{ upgrade.name }}</strong>
                        <div *ngFor="let rule of upgrade.rules" class="upgrade-rule-detail">
                          {{ rule.name }}: {{ rule.description }}
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
           </tbody>
           <tfoot>
             <tr class="total-row">
               <td colspan="8"><strong>Total Points:</strong></td>
               <td class="total-points"><strong>{{ totalPoints }}</strong></td>
             </tr>
           </tfoot>
         </table>
       </div>
  </div>
</div>
